<%= javascript_include_tag "#{@answer_js_url}" %>

<script type="text/javascript" >
  category = '<%= params[:category] %>';
  init_problem = '<%= @sheet.attributes["init"] %>';
  init_exam_user_id ='<%= params[:id] %>';
  sheet_url = '<%= @sheet_url %>';
  //将变量转化为数组 具体 ： null => [] , 'abc'=>['abc'] , 1=>[1] , {}=>[{}]  若是数组，则返回本身
  function transform_array(object){
    var result = [];
    var resource = object;
    if(resource){
      if(resource.length){
        result = resource;
      }else{
        result.push(resource);
      }
    }
    return result;
  }

  //组合标准答案和用户答案
  answers=[];
  var a = transform_array(answer.paper.problems.problem);
  for(var i=0;i<a.length;i++){
    var a2 = transform_array(a[i].question);
    answers.push(a2);
  }
  unbind_arr=[]; //记录嵌入式大题的problem_index

</script>

<!-- 初始化jplayer播放器  -->
<div id="jquery_jplayer_1"></div>
<script type="text/javascript">
  $("#jquery_jplayer_1").jPlayer({
    swfPath: "/javascripts/jplayer",
    supplied: "mp3,m4a,oga"
  });
</script>
<% constant_question_type = {"0"=>"单选题","1"=>"多选题","2"=>"判断题","3"=>"填空题","5"=>"简答题"} %>
<div class="m_top">
  <h1 class="ex_paper_h"><%= @paper["base_info"]["title"] %></h1>
  <div class="icon_func">
    <div class="float_right">
      <span class="icon_collection"><a href="javascript:void(0);" class="tooltip hover" name="收藏">收藏</a></span>
      <span class="icon_prev"><a href="javascript:void(0);" class="tooltip" name="上一题" onclick="javascript:click_prev_problem();">上一题</a></span>
      <span class="icon_next"><a href="javascript:void(0);" class="tooltip" name="下一题" onclick="javascript:click_next_problem();" >下一题</a></span>
      <span class="icon_big"><a href="javascript:void(0);" class="tooltip" onclick="javascript:ts('body',-1)" name="缩小">缩小</a></span>
      <span class="icon_small"><a href="javascript:void(0);" class="tooltip" onclick="javascript:ts('body',1)" name="放大">放大</a></span>
      <span class="icon_return"><a href="javascript:void(0);" class="tooltip" name="返回">返回</a></span>
    </div>
    <span class="icon_again"><a href="javascript:void(0);" class="tooltip" name="重做" onclick="javascript:confirm_redo();">重做</a></span>
  </div>
</div>
<% blocks = (@paper["blocks"]["block"].class==Array) ? @paper["blocks"]["block"] : @paper["blocks"]["block"].nil? ? [] : [@paper["blocks"]["block"]] %>
<% problem_index=-1 ; global_question_index=-1 ; blocks.each do |block| %>
  <% problems = (block["problems"]["problem"].class==Array) ? block["problems"]["problem"] : block["problems"]["problem"].nil? ? [] : [block["problems"]["problem"]] %>
  <% problems.each do |problem| ; problem_index+=1; %>

    <% if problem["question_type"]=="0" %>
      <div class="problem_resource" name="<%= problem_index %>" <% if (problem_index!=@sheet.attributes["init"].to_i) %> style="display:none;" <% end %> >
        <div class="m_side m_problem_bg">
          <div class="problem_box">
            <div class="problem_title">
              第<%= problem_index+1 %>题/共<span class="global_problem_sum"></span>题
            </div>
            <div class="problem_text">
              <!-- 题面后大题  初始化音频 -->
              <% audio_title_arr = problem["title"].nil? ? [] : problem["title"].split("((mp3))"); audio_src = audio_title_arr[1]; %>
              <% if audio_src != nil ; audio_title_arr[1]="<input type='button' value='播放' onclick='javascript:jplayer_play(\"#{audio_src}\");' />" ; end ; %>
              <% resource_problem_title = audio_title_arr.join("") %>
              <%= resource_problem_title.html_safe %>
            </div>
          </div>
        </div>
        <div class="m_side">
          <div class="problem_box">
            <% questions = (problem["questions"]["question"].class==Array) ? problem["questions"]["question"] : problem["questions"]["question"].nil? ? [] : [problem["questions"]["question"]] %>
            <% question_index=-1; questions.each do |question| ; question_index+=1; global_question_index+=1 ; %>
              <div class="pro_question_list border_rb pro_question_list_<%= problem_index %> p_q_line">
                <div class="pql_left">
                  <%= global_question_index+1 %>.
                </div>
                <div class="pql_right">
                  <div class="pro_qu_t pro_qu_t_<%= problem_index %> pro_qu_k pro_qu_h" id="pro_qu_t<%= "_#{problem_index}_#{question_index}" %>">
                    <div class="question_tx"><%= constant_question_type[question["correct_type"]] %></div>
                    <div class="pro_t_con"><%= question["description"] %></div>
                  </div>
                  <input type="hidden" id="exam_user_answer<%= "_#{problem_index}_#{question_index}" %>" class="exam_user_answer" value="<%= @sheet.elements["_#{problem_index}_#{question_index}"].text if @sheet.elements["_#{problem_index}_#{question_index}"] %>" />
                  <input type="hidden" id="pass_check<%= "_#{problem_index}_#{question_index}" %>" class="pass_check" />
                  <div class="red_cuo" id="red_cuo<%= "_#{problem_index}_#{question_index}" %>" style="display:none;"><img src="/assets/red_cuo.png"/>
                  </div>
                  <div class="green_dui" id="green_dui<%= "_#{problem_index}_#{question_index}" %>" style="display:none;"><img src="/assets/green_dui.png"/>
                  </div>
                  <div class="pro_qu_div" style="display: none; ">
                    <div class="pro_qu_ul">
                      <input type="hidden" id="questionattrs<%= "_#{problem_index}_#{question_index}" %>" value="<%= question["questionattrs"] %>"/>
                      <% if question["correct_type"]=="0" %>
                        <ul>
                          <% question["questionattrs"].split(";-;").each do |attr| ; attr=attr.split(") "); if attr.length>1 ; sign=attr[0] ; content=attr[1] ; else ; sign="" ; content=attr[0] ; end ; %>
                            <li>
                              <span class="single_choose_li single_choose_li<%= "_#{problem_index}_#{question_index}" %>" onclick="javascript:do_single_choose(this,$('#questionattrs<%= "_#{problem_index}_#{question_index}" %>').val(),<%= problem_index %>,<%= question_index %>);" ><%= sign %></span>
                              <p>
                                <%= content %>
                              </p>
                            </li>
                          <% end %>
                        </ul>
                      <% elsif question["correct_type"]=="1" %>
                        <ul>
                          <% question["questionattrs"].split(";-;").each do |attr| ;attr=attr.split(") "); if attr.length>1 ; sign=attr[0] ; content=attr[1] ; else ; sign="" ; content=attr[0] ; end ; %>
                            <li>
                              <span class="multi_choose_li multi_choose_li<%= "_#{problem_index}_#{question_index}" %>"  onclick="javascript:do_multi_choose(this,$('#questionattrs<%= "_#{problem_index}_#{question_index}" %>').val(),<%= problem_index %>,<%= question_index %>);"><%= sign %></span>
                              <p>
                                <%= content %>
                              </p>
                            </li>
                          <% end %>
                        </ul>
                      <% elsif question["correct_type"]=="2" %>
                        <ul>
                          <li>
                            <span class="single_choose_li judge_li<%= "_#{problem_index}_#{question_index}" %>" onclick="javascript:do_judge(this,'1',<%= problem_index %>,<%=  question_index %>);" ></span>
                            <p>
                              对/是
                            </p>
                          </li>
                          <li>
                            <span class="single_choose_li judge_li<%= "_#{problem_index}_#{question_index}" %>" onclick="javascript:do_judge(this,'0',<%= problem_index %>,<%=  question_index %>);" ></span>
                            <p>
                              错/否
                            </p>
                          </li>
                        </ul>
                      <% elsif question["correct_type"]=="3" %>
                        <input type="text" id="fill_input<%= "_#{problem_index}_#{question_index}" %>" class="input_xz" onchange="javascript:do_fill_blank(this,this.value,<%= problem_index %>,<%= question_index %>)" />
                      <% elsif question["correct_type"]=="5" %>
                        <textarea cols="" rows="" id="fill_input<%= "_#{problem_index}_#{question_index}" %>" class="textarea_xz1" onchange="javascript:do_fill_blank(this,this.value,<%= problem_index %>,<%= question_index %>);"></textarea>
                      <% end %>
                    </div>
                    <div class="jiexi" style="display:none;" id="display_jiexi<%= "_#{problem_index}_#{question_index}" %>">
                      <span class="xx_x" onclick="javascript:close_display_answer(<%= problem_index %>,<%= question_index %>);" ><img src="/assets/x.gif"/></span>
                      <div>正确答案：<span class="red" id="display_answer<%= "_#{problem_index}_#{question_index}" %>"></span></div>
                      <div id="display_analysis<%= "_#{problem_index}_#{question_index}" %>"></div>
                    </div>
                    <div id="about_words_position<%= "_#{problem_index}_#{question_index}" %>"></div>
                    <div class="pro_btn">
                      <input type="hidden" id="resource_questionattrs<%= "_#{problem_index}_#{question_index}" %>" value="<%= question["questionattrs"] %>" />
                      <button style='display:none;' id='refer_btn<%= "_#{problem_index}_#{question_index}" %>' onclick="javascript:refer_question('<%= problem["question_type"] %>','<%= question["correct_type"] %>',$('#resource_questionattrs<%= "_#{problem_index}_#{question_index}" %>').val(),<%= problem_index %>,<%= question_index %>);">更新</button>
                      <button class="t_btn" id="check_question_btn<%= "_#{problem_index}_#{question_index}" %>" onclick="javascript:check_question('<%= problem["question_type"] %>','<%= question["correct_type"] %>',$('#resource_questionattrs<%= "_#{problem_index}_#{question_index}" %>').val(),<%= problem_index %>,<%= question_index %>);">核对</button>
                      <button class="t_btn" style="display:none;" id="next_question_btn<%= "_#{problem_index}_#{question_index}" %>" onclick="javascript:do_next_question(<%= problem_index %>,<%= question_index %>);">下一题</button>
                      <a href="javascript:void(0);" onclick="javascript:open_report_error('<%= question["id"] %>');">报告错误</a>
                      <% unless question["words"].nil?||question["words"]=="" %>
                        <a href="javascript:void(0);" onclick="javascript:ajax_load_about_words('<%= question["words"] %>',<%= problem_index %>,<%= question_index %>)">相关词汇</a>
                      <% end %>
                      <a href="javascript:void(0);" style="display:none;" id="open_display_answer<%= "_#{problem_index}_#{question_index}" %>" onclick="javascript:open_display_answer(<%= problem_index %>,<%= question_index %>);">答案解析</a>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% else %>
      <div class="problem_resource" name="<%= problem_index %>" <% if (problem_index!=@sheet.attributes["init"].to_i) %> style="display:none;" <% end %> >
        <script type="text/javascript">
          unbind_arr.push(<%= problem_index %>);
        </script>
        <div class="m_side m_problem_bg">
          <div class="problem_box">
            <div class="problem_title">
              第<%= problem_index+1 %>题/共<span class="global_problem_sum"></span>题
            </div>
            <div class="problem_text">
              <!-- 题面内大题  初始化小题 -->
              <% source_title_arr = problem["title"].nil? ? [] : problem["title"].split("((sign))"); result_title_arr = [] ; result_title_arr << source_title_arr[0] %>
              <% questions = (problem["questions"]["question"].class==Array) ? problem["questions"]["question"] : problem["questions"]["question"].nil? ? [] : [problem["questions"]["question"]] %>
              <% sign_index=-1; questions.each do |question| ; sign_index+=1;element_str="<span class='span_tk'>";
                if question["correct_type"]=="0";
                  element_str += "<select class='select_tk' id='input_inner_answer_#{problem_index}_#{sign_index}' onchange='javascript:do_inner_question(0,#{problem_index},#{sign_index});'>";element_str += "<option value=''></option>";
                  question["questionattrs"].split(";-;").each do |attr|;element_str += "<option value='#{attr}'>#{attr}</option>";end;element_str += "</select>";
                elsif question["correct_type"]=="1";
                  element_str += "<div class='dragDrop_box' id='droppable_#{problem_index}_#{sign_index}' ></div>";
                elsif question["correct_type"]=="3";
                  element_str = "<input class='input_tk' type='text' id='input_inner_answer_#{problem_index}_#{sign_index}' onchange='javascript:do_inner_question(3,#{problem_index},#{sign_index});'></input>";
                end;
                element_str += "<button style='display:none;' id='refer_btn_#{problem_index}_#{sign_index}' >更新</button>"
                element_str += "<button class='button_tk' id='hedui_btn_#{problem_index}_#{sign_index}' >核对</button></span>";
                result_title_arr << element_str << source_title_arr[sign_index+1]; %>
                <script type="text/javascript" >
                  $(function(){
                    $("#hedui_btn<%= "_#{problem_index}_#{sign_index}" %>").bind("click",function(){
                      check_question('<%= problem["question_type"] %>','<%= question["correct_type"] %>',$("#resource_questionattrs<%= "_#{problem_index}_#{sign_index}" %>").val(),<%= problem_index %>,<%= sign_index %>);
                      choose_pro_question_list(<%= problem_index %>,<%= sign_index %>)
                    })
                    $("#refer_btn<%= "_#{problem_index}_#{sign_index}" %>").bind("click",function(){
                      refer_question('<%= problem["question_type"] %>','<%= question["correct_type"] %>',$("#resource_questionattrs<%= "_#{problem_index}_#{sign_index}" %>").val(),<%= problem_index %>,<%= sign_index %>);
                    })
                    if('<%= question["correct_type"] %>'=="1"){
                      $("#droppable<%= "_#{problem_index}_#{sign_index}" %>").droppable({
                        drop: function( event, ui ) {
                          $(this).html(ui.draggable.attr("name"));
                          $("#exam_user_answer<%= "_#{problem_index}_#{sign_index}" %>").val(ui.draggable.attr("name"));
                        }
                      });
                      attrs = "<%= question["questionattrs"] %>".split(";-;");
                      new_attrs = "";
                      for(var i=0;i<attrs.length;i++){
                        new_attrs += "<li name='"+attrs[i]+"' class='draggable_attr_<%= problem_index %>'>"+attrs[i]+"</li>"
                      }
                      $("#draggable_list_<%= problem_index %>").html($("#draggable_list_<%= problem_index %>").html()+new_attrs);
                    }
                  })
                </script>
              <% end %>
              <!-- 题面内大题 初始化音频  -->
              <% audio_title_arr = result_title_arr.join("").split("((mp3))"); audio_src = audio_title_arr[1]; %>
              <% audio_element = "" ;if audio_src != nil ; %>
                <% audio_element="<input type='button' id='jplayer_play_button_#{problem_index}' value='播放' /><div id='jplayer_location_#{problem_index}'></div>" ;%>
                <% audio_title_arr[1]="" ; end ; %>
              <%= "#{audio_title_arr.join('')}#{audio_element}".html_safe %>
              <script type='text/javascript'>
                //设置可拖动元素，排序，以及绑定音频播放事件
                $(function(){
                  
                  $(".draggable_attr_<%= problem_index %>").draggable({helper: "clone"});
                  $("#jplayer_play_button_<%= problem_index %>").bind("click",function(){
                    jplayer_play("<%= audio_src %>");
                  });
                })
              </script>
            </div>
            <div class="drag_tk_box" id="drag_tk_box_<%= problem_index %>">
              <div class="drag_tk border_radius" id="drag_tk_<%= problem_index %>">
                <ul id="draggable_list_<%= problem_index %>"></ul>
              </div>
            </div>
          </div>
        </div>
        <div class="m_side">
          <div class="problem_box">
            <% question_index=-1; questions.each do |question| ; question_index+=1; global_question_index+=1 ; %>
              <div class="pro_question_list border_rb pro_question_list_<%= problem_index %>" style='display:none;'>
                <div class="pql_left">
                  <%= global_question_index+1 %>.
                </div>
                <div class="pql_right">
                  <div class="pro_qu_t pro_qu_t_<%= problem_index %> pro_qu_k" id="pro_qu_t<%= "_#{problem_index}_#{question_index}" %>">
                    <%= question["description"] %>
                  </div>
                  <input type="hidden" id="exam_user_answer<%= "_#{problem_index}_#{question_index}" %>" class="exam_user_answer"  value="<%= @sheet.elements["_#{problem_index}_#{question_index}"].text if @sheet.elements["_#{problem_index}_#{question_index}"] %>"  />
                  <input type="hidden" id="pass_check<%= "_#{problem_index}_#{question_index}" %>" class="pass_check" />
                  <div class="red_cuo" id="red_cuo<%= "_#{problem_index}_#{question_index}" %>" style="display:none;"><img src="/assets/red_cuo.png"/>
                  </div>
                  <div class="green_dui" id="green_dui<%= "_#{problem_index}_#{question_index}" %>" style="display:none;"><img src="/assets/green_dui.png"/>
                  </div>
                  <div class="pro_qu_div">
                    <input type="hidden" id="resource_questionattrs<%= "_#{problem_index}_#{question_index}" %>" value="<%= question["questionattrs"] %>" />
                    <div class="jiexi" id="display_jiexi<%= "_#{problem_index}_#{question_index}" %>">
                      <span class="xx_x" onclick="javascript:close_display_answer(<%= problem_index %>,<%= question_index %>);" ><img src="/assets/x.gif"/></span>
                      <div>正确答案：<span class="red" id="display_answer<%= "_#{problem_index}_#{question_index}" %>"></span></div>
                      <div id="display_analysis<%= "_#{problem_index}_#{question_index}" %>"></div>
                    </div>
                    <div id="about_words_position<%= "_#{problem_index}_#{question_index}" %>"></div>
                    <div class="pro_btn">
                      <a href="javascript:void(0);"  onclick="javascript:open_report_error('<%= question["id"] %>');">报告错误</a>
                      <% unless question["words"].nil?||question["words"]=="" %>
                        <a href="javascript:void(0);" onclick="javascript:ajax_load_about_words('<%= question["words"] %>',<%= problem_index %>,<%= question_index %>)">相关词汇</a>
                      <% end %>
                      <a href="javascript:void(0);"  style="display:none;" id="open_display_answer<%= "_#{problem_index}_#{question_index}" %>" onclick="javascript:open_display_answer(<%= problem_index %>,<%= question_index %>);">答案解析</a>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
<% end %>
<script type="text/javascript">
  // 更新总题数
  $(".global_problem_sum").html("<%= problem_index+1 %>");
</script>

<!-- 相关词汇框 -->
<div id="about_words_loader" style="display:none;">
  <div class="jiexi" id="about_words">
    <span class="xx_x" onclick="javascript:close_about_words();" ><img alt="gankao" src="/assets/x.gif"/></span>
    <div class="xg_words">
      <ul id="about_words_list"></ul>
    </div>
    <div class="xg_words_ny">
      <div class="ch_text">
        <div class="ch_words_line">
          <span class="font_size_24" id='about_word_name'></span>
          <span id='about_word_types'></span><span id='about_word_phonetic'></span>
          <input type="hidden" id="about_word_enunciate_url" />
          <a href="javascript:void(0);" onclick="javascript:jplayer_play($('#about_word_enunciate_url').val());"><img alt="gankao" src="/assets/icon_fy.png" /></a>
        </div>
        <div class="ch_words_line">
          <p class="font_size_16" id='about_word_en_mean'></p>
          <p id='about_word_ch_mean'></p>
        </div>
        <div class="ch_words_line">
          <ul class="words_ul_font14" id="about_word_sentences"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 报告错误框  -->
<div class="upErrorTo_tab border_radius" id="report_error" style="top: 242px; left: 490px; display: none; ">
  <span class="xx_x"><img src="/assets/x.gif" onclick="javascript:close_report_error();"/></span>
  <input type="hidden" id="report_error_paper_id" value="<%= @paper["id"] %>" />
  <input type="hidden" id="report_error_paper_title" value="<%= @paper["base_info"]["title"] %>" />
  <input type="hidden" id="report_error_user_id" value="<%= cookies[:user_id] %>" />
  <input type="hidden" id="report_error_user_name" value="<%= cookies[:user_name] %>" />
  <input type="hidden" id="report_error_question_id" />
  <ul>
    <li><input name="report_error_radio" class="report_error_radio" type="radio" value="<%= ReportError::TYPE[:TOPOIC] %>"/>题目错误</li>
    <li><input name="report_error_radio" class="report_error_radio" type="radio" value="<%= ReportError::TYPE[:ANSWER] %>"/>答案错误</li>
    <li><input name="report_error_radio" class="report_error_radio" type="radio" value="<%= ReportError::TYPE[:ANALISIS] %>"/>解析错误</li>
    <li><input name="report_error_radio" class="report_error_radio" type="radio" value="<%= ReportError::TYPE[:WORD] %>"/>词汇错误</li>
  </ul>
  <textarea name="" id='report_error_description' cols="" rows=""></textarea>
  <div><button class="t_btn" onclick="ajax_report_error();">提交</button></div>
</div>


<script type="text/javascript">
  //拖选框预留高度
  $(function(){
    if($("#drag_tk_"+init_problem).height()){
      $("#drag_tk_box_"+init_problem).css("height",$("#drag_tk_"+init_problem).height());
    }
  })

  //还原用户之前操作
  $(function(){
<% @sheet.each_element do |ele| %>
      $("#refer_btn<%= ele.name %>").trigger("click");
<% end %>
  })
</script>