<%= javascript_include_tag "/assets/exam_user.js" %>
<script type="text/javascript" >
  //初始化题目号
  if(!(getCookie("init_exam_user")!= null && getCookie("init_exam_user")=="<%= params[:id] %>")){
    setCookie("init_exam_user","<%= params[:id] %>");
    setCookie("init_problem","0");
  }
  unbind_arr=[]; //记录嵌入式大题的problem_index
</script>

<!-- 初始化jplayer播放器  -->
<div id="jquery_jplayer_1" class='jp-jplayer'></div>
<script type="text/javascript">
  $("#jquery_jplayer_1").jPlayer({
    ready: function (event) {
      $(this).jPlayer("setMedia", {
        mp3:"/mp3/music.mp3"
      });
    },
    swfPath: "/javascripts/jplayer",
    supplied: "mp3,m4a,oga"
  });
</script>
<% constant_question_type = {"0"=>"单选题","1"=>"多选题","2"=>"判断题","3"=>"填空题","5"=>"简答题"} %>
<div class="m_top">
  <h1 class="ex_paper_h"><%= @paper["base_info"]["title"] %></h1>
  <div class="icon_func">
    <div class="float_right">
      <span class="icon_collection"><a href="javascript:void(0);" class="tooltip hover" name="收藏">收藏</a></span>
      <span class="icon_prev"><a href="javascript:void(0);" class="tooltip" name="上一题" onclick="javascript:click_prev_problem();">上一题</a></span>
      <span class="icon_next"><a href="javascript:void(0);" class="tooltip" name="下一题" onclick="javascript:click_next_problem();" >下一题</a></span>
      <span class="icon_big"><a href="javascript:void(0);" class="tooltip" onclick="javascript:ts('body',-1)" name="缩小">缩小</a></span>
      <span class="icon_small"><a href="javascript:void(0);" class="tooltip" onclick="javascript:ts('body',1)" name="放大">放大</a></span>
      <span class="icon_return"><a href="javascript:void(0);" class="tooltip" name="返回">返回</a></span>
    </div>
    <span class="icon_again"><a href="javascript:void(0);" class="tooltip" name="重做">重做</a></span>
  </div>
</div>
<% blocks = (@paper["blocks"]["block"].class==Array) ? @paper["blocks"]["block"] : @paper["blocks"]["block"].nil? ? [] : [@paper["blocks"]["block"]] %>
<% problem_index=-1 ; global_question_index=-1 ; blocks.each do |block| %>
  <% problems = (block["problems"]["problem"].class==Array) ? block["problems"]["problem"] : block["problems"]["problem"].nil? ? [] : [block["problems"]["problem"]] %>
  <% problems.each do |problem| ; problem_index+=1; %>

    <% if problem["question_type"]=="0" %>
      <div class="problem_resource" name="<%= problem_index %>" <% if (problem_index!=cookies["init_problem"].to_i) %> style="display:none;" <% end %> >
        <div class="m_side m_problem_bg">
          <div class="problem_box">
            <div class="problem_title">
                                      第<%= problem_index+1 %>题/共<span class="global_problem_sum"></span>题
            </div>
            <div class="problem_text">
              <!-- 题面后大题  初始化音频 -->
              <% audio_title_arr = problem["title"].nil? ? [] : problem["title"].split("((mp3))"); audio_src = audio_title_arr[1]; %>
              <% if audio_src != nil ; audio_title_arr[1]="<input type='button' value='播放' onclick='javascript:jplayer_play(\"#{audio_src}\");' />" ; end ; %>
              <% resource_problem_title = audio_title_arr.join("") %>
              <%= resource_problem_title.html_safe %>
            </div>
          </div>
        </div>
        <div class="m_side">
          <div class="problem_box">
            <% questions = (problem["questions"]["question"].class==Array) ? problem["questions"]["question"] : problem["questions"]["question"].nil? ? [] : [problem["questions"]["question"]] %>
            <% question_index=-1; questions.each do |question| ; question_index+=1; global_question_index+=1 ; %>
              <div class="pro_question_list pro_question_list_<%= problem_index %> p_q_line">
                <div class="pql_left">
                  <%= global_question_index+1 %>.
                </div>
                <div class="pql_right p_q_line">
                  <div class="pro_qu_t pro_qu_t_<%= problem_index %> pro_qu_k pro_qu_h" id="a">
                    <%= question["description"] %>
                  </div>
                  <div class="question_tx"><%= constant_question_type[question["correct_type"]] %></div>
                  <input type="hidden" id="exam_user_answer<%= "_#{problem_index}_#{question_index}" %>" class="exam_user_answer" />
                  <input type="hidden" id="pass_check<%= "_#{problem_index}_#{question_index}" %>" class="pass_check" />
                  <div class="red_cuo" id="red_cuo<%= "_#{problem_index}_#{question_index}" %>" style="display:none;"><img src="/assets/red_cuo.png"/>
                  </div>
                  <div class="green_dui" id="green_dui<%= "_#{problem_index}_#{question_index}" %>" style="display:none;"><img src="/assets/green_dui.png"/>
                  </div>
                  <div class="pro_qu_div" style="display: none; ">
                    <div class="pro_qu_ul">
                      <input type="hidden" id="questionattrs<%= "_#{problem_index}_#{question_index}" %>" value="<%= question["questionattrs"] %>"/>
                      <% if question["correct_type"]=="0" %>
                        <ul>
                          <% question["questionattrs"].split(";-;").each do |attr| ; attr=attr.split(") "); if attr.length>1 ; sign=attr[0] ; content=attr[1] ; else ; sign="" ; content=attr[0] ; end ; %>
                            <li>
                              <span class="single_choose_li single_choose_li<%= "_#{problem_index}_#{question_index}" %>" onclick="javascript:do_single_choose(this,$('#questionattrs<%= "_#{problem_index}_#{question_index}" %>').val(),<%= problem_index %>,<%= question_index %>);" ><%= sign %></span>
                              <p>
                                <%= content %>
                              </p>
                            </li>
                          <% end %>
                        </ul>
                      <% elsif question["correct_type"]=="1" %>
                        <ul>
                          <% question["questionattrs"].split(";-;").each do |attr| ;attr=attr.split(") "); if attr.length>1 ; sign=attr[0] ; content=attr[1] ; else ; sign="" ; content=attr[0] ; end ; %>
                            <li>
                              <span class="multi_choose_li multi_choose_li<%= "_#{problem_index}_#{question_index}" %>"  onclick="javascript:do_multi_choose(this,$('#questionattrs<%= "_#{problem_index}_#{question_index}" %>').val(),<%= problem_index %>,<%= question_index %>);"><%= sign %></span>
                              <p>
                                <%= content %>
                              </p>
                            </li>
                          <% end %>
                        </ul>
                      <% elsif question["correct_type"]=="2" %>
                        <ul>
                          <li>
                            <span class="single_choose_li judge_li<%= "_#{problem_index}_#{question_index}" %>" onclick="javascript:do_judge(this,'1',<%= problem_index %>,<%=  question_index %>);" ></span>
                            <p>
                                                                                          对/是
                            </p>
                          </li>
                          <li>
                            <span class="single_choose_li judge_li<%= "_#{problem_index}_#{question_index}" %>" onclick="javascript:do_judge(this,'0',<%= problem_index %>,<%=  question_index %>);" ></span>
                            <p>
                                                                                          错/否
                            </p>
                          </li>
                        </ul>
                      <% elsif question["correct_type"]=="3" %>
                        <input type="text" class="input_xz" onchange="javascript:do_fill_blank(this,this.value,<%= problem_index %>,<%= question_index %>)" />
                      <% elsif question["correct_type"]=="5" %>
                        <textarea cols="" rows="" class="textarea_xz1" onchange="javascript:do_fill_blank(this,this.value,<%= problem_index %>,<%= question_index %>);"></textarea>
                      <% end %>
                    </div>
                    <input id="resource_answer<%= "_#{problem_index}_#{question_index}" %>" type="hidden" value="<%= @answer[problem_index][question_index]["answer"] %>">
                    </input>
                    <input id="resource_analysis<%= "_#{problem_index}_#{question_index}" %>" type="hidden" value="<%= @answer[problem_index][question_index]["analysis"] %>">
                    </input>
                    <div class="pro_btn">
                      <button class="t_btn"
                              onclick="javascript:check_question(<%= question["correct_type"] %>,$('#resource_answer<%= "_#{problem_index}_#{question_index}" %>').val(),$('#resource_analysis<%= "_#{problem_index}_#{question_index}" %>').val(),<%= problem_index %>,<%= question_index %>);">
                                                                        核对
                      </button><a href="javascript:void(0);" onclick="javascript:open_report_error('<%= question["id"] %>');">报告错误</a><% unless question["words"].nil?||question["words"]=="" %><a href="javascript:void(0);" onclick="javascript:ajax_load_about_words('<%= question["words"] %>',<%= problem_index %>,<%= question_index %>)">相关词汇</a><% end %>
                    </div>
                    <div class="jiexi" style="display:none;" id="display_jiexi<%= "_#{problem_index}_#{question_index}" %>">
                      <span class="xx_x" onclick="javascript:close_display_answer(<%= problem_index %>,<%= question_index %>);" ><img src="/assets/x.gif"/></span>
                      <div>正确答案：<span class="red" id="display_answer<%= "_#{problem_index}_#{question_index}" %>"></span></div>
                      <div id="display_analysis<%= "_#{problem_index}_#{question_index}" %>"></div>
                    </div>
                    <div id="about_words_position<%= "_#{problem_index}_#{question_index}" %>"></div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% else %>
      <div class="problem_resource" name="<%= problem_index %>" <% if (problem_index!=cookies["init_problem"].to_i) %> style="display:none;" <% end %> >
        <script type="text/javascript">
          unbind_arr.push(<%= problem_index %>);
        </script>
        <div class="m_side m_problem_bg">
          <div class="problem_box">
            <div class="problem_title">
                                      第<%= problem_index+1 %>题/共<span class="global_problem_sum"></span>题
            </div>
            <div class="problem_text">
              <!-- 题面内大题  初始化小题 -->
              <% source_title_arr = problem["title"].nil? ? [] : problem["title"].split("((sign))"); result_title_arr = [] ; result_title_arr << source_title_arr[0] %>
              <% questions = (problem["questions"]["question"].class==Array) ? problem["questions"]["question"] : problem["questions"]["question"].nil? ? [] : [problem["questions"]["question"]] %>
              <% sign_index=-1; questions.each do |question| ; sign_index+=1;element_str="<span class='span_tk'>";
                if question["correct_type"]=="0";
                  element_str += "<select class='select_tk' id='input_inner_answer_#{problem_index}_#{sign_index}' onchange='javascript:do_inner_question(0,#{problem_index},#{sign_index});'>";element_str += "<option value=''></option>";
                  question["questionattrs"].split(";-;").each do |attr|;element_str += "<option value='#{attr}'>#{attr}</option>";end;element_str += "</select>";
                elsif question["correct_type"]=="1";
                  element_str += "<div class='dragDrop_box' id='droppable_#{problem_index}_#{sign_index}' ></div>";
                elsif question["correct_type"]=="3";
                  element_str = "<input class='input_tk' type='text' id='input_inner_answer_#{problem_index}_#{sign_index}' onchange='javascript:do_inner_question(3,#{problem_index},#{sign_index});'></input>";
                end;
                element_str += "<button class='button_tk' id='hedui_btn_#{problem_index}_#{sign_index}' >核对</button></span>";
                result_title_arr << element_str << source_title_arr[sign_index+1]; %>
                <script type="text/javascript" >
                  $(function(){
                    $("#hedui_btn<%= "_#{problem_index}_#{sign_index}" %>").bind("click",function(){
                      $(this).addClass("green");
                      check_question(<%= question["correct_type"] %>,$('#resource_answer<%= "_#{problem_index}_#{sign_index}" %>').val(),$('#resource_analysis<%= "_#{problem_index}_#{sign_index}" %>').val(),<%= problem_index %>,<%= sign_index %>);
                      choose_pro_question_list(<%= problem_index %>,<%= sign_index %>)
                    })
                    if('<%= question["correct_type"] %>'=="1"){
                      $("#droppable<%= "_#{problem_index}_#{sign_index}" %>").droppable({
                        drop: function( event, ui ) {
                          $(this).html(ui.draggable.attr("name"));
                          $("#exam_user_answer<%= "_#{problem_index}_#{sign_index}" %>").val(ui.draggable.attr("name"));
                        }
                      });
                      attrs = "<%= question["questionattrs"] %>".split(";-;");
                      new_attrs = "";
                      for(var i=0;i<attrs.length;i++){
                        new_attrs += "<li name='"+attrs[i]+"' class='draggable_attr_<%= problem_index %>'>"+attrs[i]+"</li>"
                      }
                      $("#draggable_list_<%= problem_index %>").html($("#draggable_list_<%= problem_index %>").html()+new_attrs);
                    }
                  })
                </script>
              <% end %>
              <!-- 题面内大题 初始化音频  -->
              <% audio_title_arr = result_title_arr.join("").split("((mp3))"); audio_src = audio_title_arr[1]; %>
              <% audio_element = "" ;if audio_src != nil ; %>
                <% audio_element="<input type='button' id='jplayer_play_button_#{problem_index}' value='播放' /><div id='jplayer_location_#{problem_index}'></div>" ;%>
                <% audio_title_arr[1]="" ; end ; %>
              <%= "#{audio_title_arr.join('')}#{audio_element}".html_safe %>
              <script type='text/javascript'>
                //设置可拖动元素，以及绑定音频播放事件
                $(function(){
                  $(".draggable_attr_<%= problem_index %>").draggable({revert: true});
                  $("#jplayer_play_button_<%= problem_index %>").bind("click",function(){
                    jplayer_play("<%= audio_src %>");
                  });
                })
              </script>
            </div>
            <div class="drag_tk_box" id="drag_tk_box_<%= problem_index %>">
              <div class="drag_tk border_radius" id="drag_tk_<%= problem_index %>">
                <ul id="draggable_list_<%= problem_index %>"></ul>
              </div>
              <script type="text/javascript">
                //设置拖选框的外层高度
                $(function(){
                  $("#drag_tk_box_<%= problem_index %>").css("height",$("#drag_tk_<%= problem_index %>").height());
                })
              </script>
            </div>
          </div>
        </div>
        <div class="m_side">
          <div class="problem_box">
            <% question_index=-1; questions.each do |question| ; question_index+=1; global_question_index+=1 ; %>
              <div class="pro_question_list pro_question_list_<%= problem_index %>" style='display:none;'>
                <div class="pql_left">
                  <%= global_question_index+1 %>.
                </div>
                <div class="pql_right">
                  <div class="pro_qu_t pro_qu_t_<%= problem_index %> pro_qu_k" id="a">
                    <%= question["description"] %>
                  </div>
                  <input type="hidden" id="exam_user_answer<%= "_#{problem_index}_#{question_index}" %>" class="exam_user_answer" />
                  <input type="hidden" id="pass_check<%= "_#{problem_index}_#{question_index}" %>" class="pass_check" />
                  <div class="red_cuo" id="red_cuo<%= "_#{problem_index}_#{question_index}" %>" style="display:none;"><img src="/assets/red_cuo.png"/>
                  </div>
                  <div class="green_dui" id="green_dui<%= "_#{problem_index}_#{question_index}" %>" style="display:none;"><img src="/assets/green_dui.png"/>
                  </div>
                  <div class="pro_qu_div"">
                       <input id="resource_answer<%= "_#{problem_index}_#{question_index}" %>" type="hidden" value="<%= @answer[problem_index][question_index]["answer"] %>">
                    </input>
                    <input id="resource_analysis<%= "_#{problem_index}_#{question_index}" %>" type="hidden" value="<%= @answer[problem_index][question_index]["analysis"] %>">
                    </input>
                    <div class="pro_btn">
                      <a href="javascript:void(0);"  onclick="javascript:open_report_error('<%= question["id"] %>');">报告错误</a><% unless question["words"].nil?||question["words"]=="" %><a href="javascript:void(0);" onclick="javascript:ajax_load_about_words('<%= question["words"] %>',<%= problem_index %>,<%= question_index %>)">相关词汇</a><% end %>
                    </div>
                    <div class="jiexi" id="display_jiexi<%= "_#{problem_index}_#{question_index}" %>">
                      <span class="xx_x" onclick="javascript:close_display_answer(<%= problem_index %>,<%= question_index %>);" ><img src="/assets/x.gif"/></span>
                      <div>正确答案：<span class="red" id="display_answer<%= "_#{problem_index}_#{question_index}" %>"></span></div>
                      <div id="display_analysis<%= "_#{problem_index}_#{question_index}" %>"></div>
                    </div>
                    <div id="about_words_position<%= "_#{problem_index}_#{question_index}" %>"></div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
<% end %>
<script type="text/javascript">
  // 显示总题数
  $(".global_problem_sum").html("<%= problem_index+1 %>");</script>

<!-- 相关词汇框 -->
<div id="about_words_loader"  >
  <div class="jiexi" id="about_words">
    <span class="xx_x" onclick="javascript:close_about_words();" ><img src="/assets/x.gif"></span>
    <div class="xg_words">
      <ul id="about_words_list"></ul>
    </div>
    <div class="xg_words_ny">
      <div class="ch_text">
        <div class="ch_words_line">
          <span class="font_size_24" id='about_word_name'></span>
          <span id='about_word_types'></span><span id='about_word_phonetic'></span>
          <input type="hidden" id="about_word_enunciate_url" />
          <a href="javascript:void(0);" onclick="javascript:jplayer_play($('#about_word_enunciate_url').val());"><img src="/assets/icon_fy.png"></a>
        </div>
        <div class="ch_words_line">
          <p class="font_size_16" id='about_word_en_mean'></p>
          <p id='about_word_ch_mean'></p>
        </div>
        <div class="ch_words_line">
          <ul class="words_ul_font14" id="about_word_sentences"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 报告错误框  -->
<div class="upErrorTo_tab border_radius" id="report_error" style="top: 242px; left: 490px; display: none; ">
  <span class="xx_x"><img src="/assets/x.gif" onclick="javascript:close_report_error();"></span>
  <input type="hidden" id="report_error_paper_id" value="<%= @paper["id"] %>" />
  <input type="hidden" id="report_error_paper_title" value="<%= @paper["base_info"]["title"] %>" />
  <input type="hidden" id="report_error_user_id" value="<%= cookies[:user_id] %>" />
  <input type="hidden" id="report_error_user_name" value="<%= cookies[:user_name] %>" />
  <input type="hidden" id="report_error_question_id" />
  <ul>
    <li><input name="report_error_radio" class="report_error_radio" type="radio" value="<%= ReportError::TYPE[:TOPOIC] %>">题目错误</li>
    <li><input name="report_error_radio" class="report_error_radio" type="radio" value="<%= ReportError::TYPE[:ANSWER] %>">答案错误</li>
    <li><input name="report_error_radio" class="report_error_radio" type="radio" value="<%= ReportError::TYPE[:ANALISIS] %>">解析错误</li>
    <li><input name="report_error_radio" class="report_error_radio" type="radio" value="<%= ReportError::TYPE[:WORD] %>">词汇错误</li>
  </ul>
  <textarea name="" id='report_error_description' cols="" rows=""></textarea>
  <div><button class="t_btn" onclick="ajax_report_error();">提交</button></div>
</div>


<script type=text/javascript>
        //用户操作题目内小题
	function do_inner_question(correct_type,problem_index,question_index){
		var this_answer = $("#input_inner_answer_"+problem_index+"_"+question_index).val(); 
		$("#exam_user_answer_"+problem_index+"_"+question_index).val(this_answer);
	}

	//题面内小题，需要隐藏右边的小题框
	function choose_pro_question_list(problem_index,question_index){
		$(".pro_question_list_"+problem_index).hide();
		$(".pro_question_list_"+problem_index+":eq("+question_index+")").show();
	}

	//播放音频
        function jplayer_play(src){
        $("#jquery_jplayer_1").jPlayer("setMedia", {
        mp3: src
        });
        $("#jquery_jplayer_1").jPlayer("play");
        }

        //ajax载入相关词汇
	function ajax_load_about_words(words,problem_index,question_index){
	$.ajax({
        type: "POST",
        url: "/exam_users/ajax_load_about_words.json",
        dataType: "json",
        data : {
        "words":words
        },
        success : function(data) {
        	words_arr = words.split(";");
        	$("#about_words_list").empty();
        	html_str="";
        	n=0;
        	for(var i=0;i<words_arr.length;i++){
        	  if(data[i]!=null){
        	  html_str +="<li>";
                    html_str +="<a class='single_word_li' href='javascript:void(0);' onclick='javascript:show_single_word(this,"+n+");'>"+data[n].name+"</a>";
                    html_str +="<input type='hidden' id='about_word_name_"+n+"' value='"+data[n].name+"' />";
                    html_str +="<input type='hidden' id='about_word_category_id_"+n+"' value='"+data[n].category_id+"' />";
                    html_str +="<input type='hidden' id='about_word_en_mean_"+n+"' value='"+data[n].en_mean+"' />";
                    html_str +="<input type='hidden' id='about_word_ch_mean_"+n+"' value='"+data[n].ch_mean+"' />";
                    html_str +="<input type='hidden' id='about_word_types_"+n+"' value='"+data[n].types+"' />";
                    html_str +="<input type='hidden' id='about_word_phonetic_"+n+"' value='"+data[n].phonetic+"' />";
                    html_str +="<input type='hidden' id='about_word_enunciate_url_"+n+"' value='"+data[n].enunciate_url+"' />";
                    html_str +="<input type='hidden' id='about_word_sentences_"+n+"' value='"+data[n].sentences+"' />";
                    html_str +="</li>";
                    n++;
			  
        	  }
        	}
        	$("#about_words_list").html(html_str);
        	$(".single_word_li:eq(0)").trigger("click");
        	if(data["error"]==null){
                  $("#about_words_position_"+problem_index+"_"+question_index).append($("#about_words"));
        	}else{
                  tishi_alert(data["error"]);
        	}
        	
              }
            });
          }
	
          //关闭相关词汇框
          function close_about_words(){
            $("#about_words_loader").append($("#about_words"));
          }
	
          //打开报告错误框
          function open_report_error(question_id){
            $("#report_error").show();
            $("#report_error_description").val("");
            $(".report_error_radio").attr("checked",false);
            $("#report_error_question_id").val(question_id);
          }
	
          //ajax报告错误
          function ajax_report_error(){
            if(!$(".report_error_radio:checked").val()){
              tishi_alert("请选择错误类型");
              return false;
            }
            $.ajax({
              type: "POST",
              url: "/exam_users/ajax_report_error.json",
              dataType: "json",
              data : {
        	"post":{
                  "paper_id":$("#report_error_paper_id").val(),
                  "paper_title":$("#report_error_paper_title").val(),
                  "user_id":$("#report_error_user_id").val(),
                  "user_name":$("#report_error_user_name").val(),
                  "description":$("#report_error_description").val(),
                  "error_type":$(".report_error_radio:checked").val(),
                  "question_id":$("#report_error_question_id").val()
                }
              },
              success : function(data) {
        	tishi_alert(data["message"]);
              }
            });
          }
	
          //关闭报告错误框
          function close_report_error(){
            $("#report_error").hide();
          }
	
          function show_single_word(ele,i){
	    $(".single_word_li").removeClass("hover");
            $(ele).addClass("hover");
            $("#about_word_name").html($("#about_word_name_"+i).val());
            $("#about_word_en_mean").html($("#about_word_en_mean_"+i).val());
            $("#about_word_ch_mean").html($("#about_word_ch_mean_"+i).val());
            $("#about_word_types").html($("#about_word_types_"+i).val());
            $("#about_word_phonetic").html($("#about_word_phonetic_"+i).val());
            $("#about_word_enunciate_url").val($("#about_word_enunciate_url_"+i).val());
            var sentences = $("#about_word_sentences_"+i).val().split(";");
            var sentences_html = "";
            for(var i=0;i<sentences.length;i++){
              if(sentences[i]!=""){
                sentences_html += "<li>"+sentences[i]+"</li>";
              }
            }
            $("#about_word_sentences").html(sentences_html);
          }
      </script>

